---
title: "US Employment Patterns by Industry, 2005 - 2019"
author: "Cameron Marks, Derrick Michelson, Staci Nevinski, Courtney True"
date: "December 15, 2021"
output:
  html_document:
    df_print: paged
  html_notebook: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, fig.width = 12, fig.height = 8)
```

# Cleaning and Setup Data for Exploration
This notebook begins with the csv created from APIBuildDataset.R which pulls the US Census CBP data from 2005 - 2019.

```{r, warning = FALSE, message=FALSE}
# Cleaning and Setup

## Prep dataset
#Cleaning
# * Remove "Statewide" summary rows
# * Remove Territories (but leave DC)
# * X Make County name consistent
# * X Split COUNTY into County and State
# * X Make LFO (Name of industry) consistent
# * coerce factor variables to be factors (NOT DONE YET)

# Add a date type field for the year. Maybe 3/15/YEAR

# Deal with inflation (Use Consumer Price Index)
# * merge in inflation factors and convert to 2019 dollars
# * Annual Payroll adjusted for inflation
# * Quarter 1 payroll adjusted for inflation

# Add Average wage rates 
# * Average wage rate for all industries by county
# * Average wage rate for a given industry by county
# * Average wage rate for all industries by state
# * Average wage rate for a given industry by state


library(dplyr)
library(tidyr)
library(stringr)
library(lubridate)

# Create a not in operator:
`%notin%` <- Negate(`%in%`)

# Read in Census Data
df <- read.csv("FinalProjectDataset.csv")

# Remove summary "Statewide" rows
df<-df %>% filter(substr(df$COUNTYSTATE,1,9)!="Statewide")
# Removes 4,683 rows that are statewide aggregate numbers


## Remove Territories
# * 60 = American Samoa
# * 66 = Guam
# * 69 = Commonwealth of the Northern Mariana Islands
# * 72 = Puerto Rico
# * 78 = United States Virgin Islands
 
## But Keep Washington DC
# * 11 = District of Columbia
 
excludeList <- list(60,66,69,72,78) # If we want to get rid of DC add 11 to this list
df<-df %>% filter(!STATENUM %in% excludeList)
# Removes 21,604 rows that are records on the territories

## Make County Name consistent

# add a field to df that concatenates state and county nums (STCTYNUM)
#df<-mutate(df,STCTYNUM=paste(str_pad(df$STATENUM,2,pad="0"),str_pad(df$COUNTYNUM,3,pad="0"),sep="_"))
df<-mutate(df,STCTYNUM=paste(str_pad(df$STATENUM,2,pad="0"),str_pad(df$COUNTYNUM,3,pad="0"),sep=""))

# create df of 2019 county names, state names, and STCTYNUM
countiesNames <- df %>% filter(YEAR == 2019) %>% 
  group_by(COUNTYSTATE) %>%
  summarise(
    COUNTY19 = unique(COUNTYSTATE),
    COUNTYNUM = unique(COUNTYNUM),
    STATENUM = unique(STATENUM)
  ) %>% 
  #mutate(STCTYNUM=paste(str_pad(STATENUM,2,pad="0"),str_pad(COUNTYNUM,3,pad="0"),sep="_")) %>% # Add concat of state and county nums (with underscore)
  mutate(STCTYNUM=paste(str_pad(STATENUM,2,pad="0"),str_pad(COUNTYNUM,3,pad="0"),sep="")) %>% # Add concat of state and county nums
  separate(COUNTY19,c("COUNTY","STATE"),sep=", ") %>% # split county and state names
  select(COUNTY,STATE,STCTYNUM) %>%
  arrange(STCTYNUM)

# Add to countiesNames the 14 that are missing from 2019
Missing2019 <- data.frame(COUNTY = c("Prince of Wales Outer Ketchikan Census Area",
                                     "Skagway-Hoonah-Angoon Census Area",
                                     "Kusilvak Census Area", 
                                     "Wrangell-Petersburg Census Area",
                                     "Kalawao County", "Petroleum County",
                                     "Banner County", "McPherson County",
                                     "Esmeralda County", "Oglala Lakota County",
                                     "Borden County", "King County", 
                                     "Loving County", "Bedford City"),
                          STATE = c("Alaska", "Alaska", "Alaska", "Alaska", 
                                    "Hawaii", "Montana", "Nebraska", "Nebraska",
                                    "Nevada", "South Dakota", "Texas", "Texas",
                                    "Texas", "Virginia"),
#                          STCTYNUM = c("02_201", "02_232", "02_270", "02_280",
#                                       "15_005", "30_069", "31_007", "31_117",
#                                       "32_009", "46_113", "48_033", "48_269", 
#                                       "48_301","51_515"))
                          STCTYNUM = c("02201", "02232", "02270", "02280",
                                       "15005", "30069", "31007", "31117",
                                       "32009", "46113", "48033", "48269", 
                                       "48301","51515"))

countiesNames <- rbind(countiesNames, Missing2019)

# Add COUNTY and STATE to df
#df<-merge(df,counties2019, by="STCTYNUM", all=TRUE) # use this one to debug the missing records
df <- merge(df, countiesNames, by="STCTYNUM")

## Make LFO consistent
industries <- df %>% filter(YEAR == 2019) %>% 
  group_by(NAIC) %>%
  summarise(
    INDUSTRY = unique(LFO),
  ) %>% 
  arrange(INDUSTRY)

# Need to trim the whitespace off NAIC.
df$NAIC <- str_trim(df$NAIC, side="both")

#df<-merge(df, industries, by="NAIC")
df<-merge(df, industries, by="NAIC",all=TRUE)

## Add a date type field for the year. Maybe 3/15/YEAR

df$DATE <- mdy(paste("03", "15", df$YEAR, sep="/"))

##Deal with inflation (Use Consumer Price Index)
# * merge in inflation factors and convert to 2019 dollars
# * Annual Payroll adjusted for inflation
# * Quarter 1 payroll adjusted for inflation

# Add inflation multiplier to convert to 2019 dollars to df
CPI <- read.csv("CPI2019.csv")
CPI<-CPI[,c("Year","CPI_2019")] # removed Annual column before merge
df<-merge(df, CPI, by.x="YEAR", by.y="Year")

# Add fields for Annual Payroll and Quarterly Payroll in 2019 dollars
df$PAYANN_19DOL = df$PAYANN * df$CPI_2019
df$PAYQTR1_19DOL = df$PAYQTR1 * df$CPI_2019

## Average wage rates by year
# * Average wage rate for a given industry by county
# * Average wage rate by county, regardless of industry
# * Average wage rate for each state, regardless of industry
# * Average wage rate for an industry by state
 
# Round these new fields to 2 decimal places

# Average wage rate for counties, regardless of industry
df<-df %>% group_by(STCTYNUM) %>%
  mutate(CTYPAYRATE = round(sum(PAYANN)/sum(EMP), digits=2)) %>%  ## not adj for inflation
  mutate(CTYPAYRATE_19DOL = round(sum(PAYANN_19DOL)/sum(EMP), digits=2)) %>% ## adjusted to 2019 dollars
  ungroup()

#Average wage rate by Year-County-Industry, add to df
df$CTYPAYRATE_NAIC = round(df$PAYANN/df$EMP, digits=2)  ## not adj for inflation
df$CTYPAYRATE_NAIC_19DOL = round(df$PAYANN_19DOL/df$EMP, digits=2) ## adjusted to 2019 dollars

# Average wage rate for each state, regardless of industry
df <- df %>% group_by(STATENUM) %>%
  mutate(STATEPAYRATE = round(sum(PAYANN)/sum(EMP), digits=2))  %>%  ## not adj for inflation
  mutate(STATEPAYRATE_19DOL = round(sum(PAYANN_19DOL)/sum(EMP), digits=2)) %>% ## adjusted to 2019 dollars
  ungroup()

# Average wage rate for an industry by state
df<-df %>% group_by(STATENUM,NAIC) %>%
  mutate(STATEPAYRATE_NAIC = round(sum(PAYANN)/sum(EMP), digits=2)) %>% ## not adj for inflation
  mutate(STATEPAYRATE_NAIC_19DOL = round(sum(PAYANN_19DOL)/sum(EMP), digits=2)) %>% ## adjusted to 2019 dollars
  ungroup()

##Coerce to factors
# * NAIC
# * STCTYNUM
# * STATENUM
# * COUNTYNUM
# * COUNTY
# * STATE

df$NAIC <- as.factor(df$NAIC)
# Not factoring these because usmap wants them as characters
#df$STCTYNUM <- as.factor(df$STCTYNUM)
df$STATENUM <- as.factor(df$STATENUM)
df$COUNTYNUM <- as.factor(df$COUNTYNUM)
df$COUNTY <- as.factor(df$COUNTY)
df$STATE <- as.factor(df$STATE)

# for usmap
df$FIPS_ST <-str_sub(df$STCTYNUM,1,2)
df$FIPS_CTY <-as.character(df$STCTYNUM)

# Remove fields no longer needed
df<- df %>% select(-c("COUNTYSTATE","LFO"))

str(df)

```


#### Total Employment and Average Salary for Each State by Year
#### (in 2019 dollars)
```{r}

stateStats <- df %>% group_by(YEAR,STATE) %>% summarize(
  TotalEmployment = sum(EMP),
  AvgAnnualWage = mean(PAYANN_19DOL)
)

topInd <- df %>% group_by(YEAR,STATE) %>% top_n(1,EMP) %>% arrange(STATE,.by_group=TRUE) 

merge(stateStats,topInd) %>% select(STATE,YEAR,TotalEmployment,AvgAnnualWage) %>% arrange(STATE, YEAR)
```


## Setup for Plotting
We remove NAIC 99 from consideration in our plots. It is used for industries that are not classified.

```{r, warning = FALSE, message=FALSE}
# Remove Industry 99: "Industries not classified"
df<-df%>%filter(NAIC!=99)

# Load libraries needed for plotting
library(ggplot2)
library(ggrepel)
library(usmap)   # https://rdrr.io/cran/usmap/f/vignettes/mapping.Rmd
library(scales)

# Setup plotting colors by NAIC code
industries<-industries %>% arrange(INDUSTRY)

plotColor<-c(
"Accommodation and food services"="red",
"Administrative and support and waste management and remediation services"="blue",
"Agriculture, forestry, fishing and hunting"="pink",
"Arts, entertainment, and recreation"="MediumVioletRed",
"Construction"="Salmon",
"Educational services"="BlueViolet",
"Finance and insurance"="YellowGreen",
"Health care and social assistance"="SeaGreen",
"Industries not classified"="Tan",
"Information"="maroon",
"Management of companies and enterprises"="limegreen",
"Manufacturing"="DarkOliveGreen",
"Mining, quarrying, and oil and gas extraction"="springgreen",
"Other services (except public administration)"="orange",
"Professional, scientific, and technical services"="turquoise",
"Real estate and rental and leasing"="SteelBlue",
"Retail trade"="khaki",
"Transportation and warehousing"="orchid",
"Utilities"="DarkBlue",
"Wholesale trade"="RosyBrown"
)
industries<- cbind(industries, plotColor)

```


Looking back in history, jobs and industries evolve across the United States as different industries see growth and decline. Industries that formerly employed millions of people see declines, while other industries see rapid growth. These changes across industries can be caused by many things such as economic changes, advances in technology, and changes in politics such as funding for specific industries or tariffs.  

For this analysis, we examined the number of people employed, total annual payroll and number of employers by industry at the state and county level. This report highlights industry patterns at the state level and highlights changes in industry employment patterns we discovered within the context of related social and economic events. 

# Findings

## Top Industries by State
Identifying the top industry in each state depends on how you measure it. We examined “top” in three ways: annual payroll by industry, annual employment by industry, and number of establishments by industry. 
### Highest Number of Employees
Total employment across much of the United States is dominated by the health care and social assistance industry. In 2019, the healthcare industry reported the highest number of employees in 80% of US states. This has been a change over time since 2005 when the Manufacturing and Retail industries more evenly shared the top spot with Healthcare across the US. 

```{r, warning = FALSE, message=FALSE}
# bar chart (histogram of number of states) with Number of states on the y axis, and
# industries (ranked #1 in # off employees in 2019) along the x axis. Bar height is the number of states where the
# industry ranks #1 in # of employees.

ToPlot <- df %>% filter(YEAR==2019) %>%
  group_by(FIPS_ST, INDUSTRY) %>%
  summarise(Total = sum(EMP)) %>%
  filter(Total == max(Total)) %>%
  group_by(INDUSTRY) %>%
  tally(name="Number Of States") %>%
  arrange(desc(`Number Of States`)) %>%
  merge(industries) # for color

cols<-ToPlot%>%
  group_by(INDUSTRY)%>%summarize(pc=unique(plotColor))

ggplot(ToPlot, aes(x=reorder(INDUSTRY,+`Number Of States`), y=`Number Of States`, fill=INDUSTRY)) +
  geom_bar(stat = "identity") +
  coord_flip() +
  theme(axis.title.y=element_blank(),legend.position = "none") +
  labs(title = "2019 Top Industries in the US", subtitle="by Number of Employees") +
  scale_fill_manual(values=cols$pc, name="Industries", labels=cols$INDUSTRY)

```

#### Top Industry by Number of Employees in Each State

```{r, warning = FALSE, message=FALSE}

# 2019 Choropleth
thisYear = 2019

ToPlot <- df %>% filter(YEAR==thisYear) %>%
  group_by(FIPS_ST, INDUSTRY) %>%
  summarise(TotalEmp = sum(EMP)) %>%
  filter(TotalEmp == max(TotalEmp)) %>% 
  merge(industries)
ToPlot<-rename(ToPlot, "fips"="FIPS_ST")

cols<-ToPlot%>%
  group_by(INDUSTRY)%>%summarize(pc=unique(plotColor))

plot_usmap(data = ToPlot, values="INDUSTRY") + 
  scale_fill_manual(values=cols$pc, name="Industries", labels=cols$INDUSTRY) +
  labs(title = paste(as.character(thisYear),"Top Industry by Number of Employees in Each State",sep=" ")) + 
  theme(legend.position = "right", title=element_text(size=12))

# 2005 Choropleth
thisYear = 2005

ToPlot <- df %>% filter(YEAR==thisYear) %>%
  group_by(FIPS_ST, INDUSTRY) %>%
  summarise(TotalEmp = sum(EMP)) %>%
  filter(TotalEmp == max(TotalEmp)) %>% 
  merge(industries)
ToPlot<-rename(ToPlot, "fips"="FIPS_ST")

cols<-ToPlot%>%
  group_by(INDUSTRY)%>%summarize(pc=unique(plotColor))

plot_usmap(data = ToPlot, values="INDUSTRY") + 
  scale_fill_manual(values=cols$pc, name="Industries", labels=cols$INDUSTRY) +
  labs(title = paste(as.character(thisYear),"Top Industry by Number of Employees in Each State",sep=" ")) + 
  theme(legend.position = "right", title=element_text(size=12))

```

### Largest Annual Payroll
However, when considering annual payroll, healthcare was not always on top of the list. The choropleth map shows a broader set of industries taking the top spot for each state. In New York, Finance and insurance showed up as the industry with the largest annual payroll, while Virginia, DC, Colorado, and California’s top spots were held by Professional, scientific, and technical services.

```{r, warning = FALSE, message=FALSE}

# 2019 Choropleth of largest annual payroll by state
thisYear = 2019 

ToPlot <- df %>% filter(YEAR==thisYear) %>%
  group_by(FIPS_ST, INDUSTRY) %>%
  summarise(TotalPayAnn = sum(PAYANN_19DOL)) %>%
  filter(TotalPayAnn == max(TotalPayAnn)) %>% 
  merge(industries)
ToPlot<-rename(ToPlot, "fips"="FIPS_ST")

cols<-ToPlot%>%
  group_by(INDUSTRY)%>%summarize(pc=unique(plotColor))

plot_usmap(data = ToPlot, values="INDUSTRY") + 
  scale_fill_manual(values=cols$pc, name="Industries", labels=cols$INDUSTRY) +
  labs(title = paste(as.character(thisYear),"Top Industry by Annual Payroll in Each State",sep=" ")) + 
  theme(legend.position = "right", title=element_text(size=12))

# 2005 Choropleth of largest annual payroll by state
thisYear = 2005 

ToPlot <- df %>% filter(YEAR==thisYear) %>%
  group_by(FIPS_ST, INDUSTRY) %>%
  summarise(TotalPayAnn = sum(PAYANN_19DOL)) %>%
  filter(TotalPayAnn == max(TotalPayAnn)) %>% 
  merge(industries)
ToPlot<-rename(ToPlot, "fips"="FIPS_ST")

cols<-ToPlot%>%
  group_by(INDUSTRY)%>%summarize(pc=unique(plotColor))

plot_usmap(data = ToPlot, values="INDUSTRY") + 
  scale_fill_manual(values=cols$pc, name="Industries", labels=cols$INDUSTRY) +
  labs(title = paste(as.character(thisYear),"Top Industry by Annual Payroll in Each State",sep=" ")) + 
  theme(legend.position = "right", title=element_text(size=12))

```

### Highest Number of Establishments
Lastly, when looking at the number of establishments, to no surprise, retail trade filled the map. This makes sense because there are many retail establishments across the United States. While retail establishments are vast in number and second in the US for the number of employees, the low wage rate in the sector drives their total payroll numbers to the middle of the pack. 

```{r, warning = FALSE, message=FALSE}

# 2019 Choropleth of Number of Establishments in each state
thisYear = 2019 

ToPlot <- df %>% filter(YEAR==thisYear) %>%
  group_by(FIPS_ST, INDUSTRY) %>%
  summarise(TotalEstab = sum(ESTAB)) %>%
  filter(TotalEstab == max(TotalEstab)) %>% 
  merge(industries)
ToPlot<-rename(ToPlot, "fips"="FIPS_ST")

cols<-ToPlot%>%
  group_by(INDUSTRY)%>%summarize(pc=unique(plotColor))

plot_usmap(data = ToPlot, values="INDUSTRY") + 
  scale_fill_manual(values=cols$pc, name="Industries", labels=cols$INDUSTRY) +
  labs(title = paste(as.character(thisYear),"Top Industry by Number of Establishments in Each State",sep=" ")) + 
  theme(legend.position = "right", title=element_text(size=12))

# 2005 Choropleth of Number of Establishments in each state
thisYear = 2005 

ToPlot <- df %>% filter(YEAR==thisYear) %>%
  group_by(FIPS_ST, INDUSTRY) %>%
  summarise(TotalEstab = sum(ESTAB)) %>%
  filter(TotalEstab == max(TotalEstab)) %>% 
  merge(industries)
ToPlot<-rename(ToPlot, "fips"="FIPS_ST")

cols<-ToPlot%>%
  group_by(INDUSTRY)%>%summarize(pc=unique(plotColor))

plot_usmap(data = ToPlot, values="INDUSTRY") + 
  scale_fill_manual(values=cols$pc, name="Industries", labels=cols$INDUSTRY) +
  labs(title = paste(as.character(thisYear),"Top Industry by Number of Establishments in Each State",sep=" ")) + 
  theme(legend.position = "right", title=element_text(size=12))

```

#### Average Pay Rates by Industry for Entire US

```{r, warning = FALSE, message=FALSE}
# Average pay rate line graph for all industries 
ToPlot <- df %>%
  group_by(YEAR, NAIC) %>%
  summarise(PayRate = sum(PAYANN_19DOL)/sum(EMP)) %>% 
  merge(industries)

cols<-ToPlot%>%group_by(NAIC,INDUSTRY)%>%summarize(pc=unique(plotColor))

ToPlot %>% 
  mutate(label = if_else(YEAR == 2019, as.character(NAIC), NA_character_)) %>%
  ggplot(aes(x=YEAR, y=PayRate, color=NAIC))+
  scale_colour_manual(values=cols$pc, name="Industries", labels=c(paste(cols$NAIC,cols$INDUSTRY,sep=": "))) +
  geom_line(size=1.25, alpha=.6, key_glyph="rect") +
  scale_x_continuous(n.breaks = 15,expand=c(0,0,0,2)) +
  scale_y_continuous(labels=dollar) +
  geom_label_repel(aes(label = label), nudge_x=2, na.rm=TRUE, show.legend=FALSE) +
  labs(title="United States: Average Pay Rate by Industry (in 2019 dollars)", x="Year", y="Avg. Pay Rate")
```


```{r, warning = FALSE, message=FALSE}
# Average pay rate choropleth, 2019
thisYear = 2019 # Just change this line to customize for year

ToPlot <- df %>% filter(YEAR==thisYear) %>%
  group_by(FIPS_ST, INDUSTRY) %>%
  summarise(PayRate = sum(PAYANN_19DOL)/sum(EMP)) %>%
  filter(PayRate == max(PayRate)) %>% 
  merge(industries)
ToPlot<-rename(ToPlot, "fips"="FIPS_ST")

cols<-ToPlot%>%
  group_by(INDUSTRY)%>%summarize(pc=unique(plotColor))

plot_usmap(data = ToPlot, values="INDUSTRY") + 
  scale_fill_manual(values=cols$pc, name="Industries", labels=cols$INDUSTRY) +
  labs(title = paste(as.character(thisYear),"Highest Pay Rate by Industry in Each State",sep=" ")) + 
  theme(legend.position = "right", title=element_text(size=12))
```

## Industry Highlights 

### Healthcare 
Throughout the data we analyzed, the healthcare industry surprised us in many ways. As of 2019, the healthcare industry in the United States has the highest annual payroll and the highest number of employees compared to any other industry. This industry has held this honor in almost every year between 2005 and 2019. Additionally, the healthcare industry has seen very consistent growth year-over-year, even during the 2008/2009 recession. Following the passage of Obamacare resulting in 20 million more Americans having access to healthcare in 2014, the rate of growth of the number employed in healthcare accelerated and continued through 2019. Interestingly, no similar increase is seen in the insurance industry at this time. Healthcare demonstrates that it is highly recession-proof and does not appear to be stopping its growth any time soon.  

```{r, warning = FALSE, message=FALSE}
# Healthcare has highest annual payroll of all industries in the US in 2019
df%>%filter(YEAR==2019) %>%
  group_by(INDUSTRY)%>%
  summarise(AnnualPayroll=sum(PAYANN_19DOL)) %>%
  arrange(desc(AnnualPayroll))
```

```{r, warning = FALSE, message=FALSE}

# Line graph of all industries of # of employees
ToPlot <- df %>%
  group_by(YEAR, NAIC) %>%
  summarise(TotalEmp = sum(EMP)) %>% 
  merge(industries)

cols<-ToPlot%>%group_by(NAIC,INDUSTRY)%>%summarize(pc=unique(plotColor))

ToPlot %>% 
  mutate(label = if_else(YEAR == 2019, as.character(NAIC), NA_character_)) %>%
  ggplot(aes(x=YEAR, y=TotalEmp, color=NAIC))+
  scale_colour_manual(values=cols$pc, name="Industries", labels=c(paste(cols$NAIC,cols$INDUSTRY,sep=": "))) +
  geom_line(size=1.25, alpha=.6, key_glyph="rect") +
  scale_x_continuous(n.breaks = 15, expand=c(0,0,0,2)) +
  scale_y_continuous(labels=comma) +
  geom_label_repel(aes(label = label), nudge_x=2, na.rm=TRUE, show.legend=FALSE) +
  labs(title="United States: Total Number Employed by Industry", x="Year", y="Employees")

```

```{r}

### Entire US - Annual Payroll by Industry
ToPlot <- df %>%
  group_by(YEAR, NAIC) %>%
  summarise(TotalPayAnn = sum(PAYANN_19DOL)) %>% 
  merge(industries)

cols<-ToPlot%>%group_by(NAIC,INDUSTRY)%>%summarize(pc=unique(plotColor))

ToPlot %>% 
  mutate(label = if_else(YEAR == 2019, as.character(NAIC), NA_character_)) %>%
  ggplot(aes(x=YEAR, y=TotalPayAnn, color=NAIC)) +
  scale_colour_manual(values=cols$pc, name="Industries", labels=c(paste(cols$NAIC,cols$INDUSTRY,sep=": "))) +
  geom_line(size=1.25, alpha=.6, key_glyph="rect") +
  scale_x_continuous(n.breaks = 15, expand=c(0,0,0,2)) +
  scale_y_continuous(labels=dollar) +
  geom_label_repel(aes(label = label), nudge_x=2, na.rm=TRUE, show.legend=FALSE) +
  labs(title="United States: Total Annual Payroll by Industry (in 2019 dollars)", x="Year", y="Total Annual Payroll")

```

### Utilities
In 2009 the American Recovery and Reinvestment Act was signed into law providing the US Department of Energy with $4.5 billion to modernize the electric power grid. It took the department five years to develop its granting processes and to distribute these funds. Upon their distribution, the number employed in the sector shot up 104% between 2014 and 2015. This increase is most visible in the line graph of the average number of employees per establishment. The average pay rate also increased sharply across the industry in 2016 and continued to rise through 2019. (See graph above under Average Pay Rates by industry for Entire US)

```{r, warning = FALSE, message=FALSE}
# Number of employees in Utilities went up 104% between 2014 and 2015

util2014ees<- as.integer( df %>% filter(YEAR==2014,INDUSTRY=="Utilities") %>%
  summarise(sum(EMP)) )

util2015ees<- as.integer( df %>% filter(YEAR==2015,INDUSTRY=="Utilities") %>%
  summarise(sum(EMP)) )

(util2015ees-util2014ees)/util2014ees

```

#### Average Number of Employees per Establishment
```{r, warning = FALSE, message=FALSE}
# Line graph of Average number of employees per establishment.
ToPlot <- df %>%
  group_by(YEAR, NAIC) %>%
  summarise(EERate = sum(EMP)/sum(ESTAB)) %>% 
  merge(industries)

cols<-ToPlot%>%group_by(NAIC,INDUSTRY)%>%summarize(pc=unique(plotColor))

ToPlot %>% 
  mutate(label = if_else(YEAR == 2019, as.character(NAIC), NA_character_)) %>%
  ggplot(aes(x=YEAR, y=EERate, color=NAIC))+
  scale_colour_manual(values=cols$pc, name="Industries", labels=c(paste(cols$NAIC,cols$INDUSTRY,sep=": "))) +
  geom_line(size=1.25, alpha=.6, key_glyph="rect") +
  scale_x_continuous(n.breaks = 15, expand=c(0,0,0,2)) +
  scale_y_continuous(labels=comma) +
  geom_label_repel(aes(label = label), nudge_x=2, na.rm=TRUE, show.legend=FALSE) +
  labs(title="United States: Average Employees per Establishment by Industry", x="Year", y="Employees per Establishment")

```



```{r, warning = FALSE, message=FALSE}

# States that saw big increases in the number of Utilities Employees between 2014 and 2015

util2014ees<-df%>%filter(YEAR==2014,INDUSTRY=="Utilities")%>%
  group_by(STATE)%>%
  summarise(Employees2014=sum(EMP))
  
util2015ees<-df%>%filter(YEAR==2015,INDUSTRY=="Utilities")%>%
  group_by(STATE)%>%
  summarise(Employees2015=sum(EMP))

merge(util2014ees,util2015ees,by="STATE") %>%
  mutate(ChangeInNumOfEEs=Employees2015-Employees2014) %>%
  mutate(PercentChangeInNumOfEES=ChangeInNumOfEEs/Employees2014) %>%
  arrange(desc(PercentChangeInNumOfEES))

```


```{r, warning = FALSE, message=FALSE}

# When comparing increases in annual payroll between 2005 and 2019 by industry, 
# the utilities industry saw the largest increase at 285%
# the manufacturing industry saw the lowest growth at only 62.5%.

Pay2005<-df%>%filter(YEAR==2005)%>%
  group_by(INDUSTRY) %>%
  summarise(Payroll2005 = sum(PAYANN_19DOL))

Pay2019<-df%>%filter(YEAR==2019)%>%
  group_by(INDUSTRY) %>%
  summarise(Payroll2019 = sum(PAYANN_19DOL))

merge(Pay2005,Pay2019,by="INDUSTRY") %>%
  mutate(ChangeInPayroll=Payroll2019-Payroll2005) %>%
  mutate(PercentChangeInPayroll=ChangeInPayroll/Payroll2005) %>%
  arrange(desc(PercentChangeInPayroll))

```


### Manufacturing
US Manufacturing has seen its fair share of difficulties over the years. Globalization and economic policies have caused a large amount of manufacturing to move out of the United States. Overall, manufacturing has seen a steady decline in the number of establishments across the United States since 2005. Manufacturing was greatly affected by the 2008/2009 recession and although the total number of employees is slowly increasing each year, it has not fully recovered to 2005 levels. In comparing increases in annual payroll between 2005 and 2019, the manufacturing industry saw the lowest growth at only 62.5%.

```{r, warning = FALSE, message=FALSE}
# Line chart for Manufacturing, Number of Establishments
ToPlot <- df %>% filter(NAIC=='31-33') %>%
  group_by(YEAR, NAIC) %>%
  summarise(TotalEstab = sum(ESTAB)) %>%
  merge(industries)

cols<-ToPlot%>%group_by(NAIC,INDUSTRY)%>%summarize(pc=unique(plotColor))

ToPlot %>% 
  ggplot(aes(x=YEAR, y=TotalEstab, color=NAIC))+
  scale_colour_manual(values=cols$pc, name="Industries", labels=c(paste(cols$NAIC,cols$INDUSTRY,sep=": "))) +
  geom_line(size=1.25) +
  scale_x_continuous(n.breaks = 15) +
  scale_y_continuous(labels=comma) +
  labs(title="United States: Number of Manufacturing Establishments by Year", x="Year", y="Establishments") +
  theme(legend.position="none")
```

Like the utilities industry, manufacturing saw a larger than normal growth in 2015 for total employed. Overall, it appears that since 2010, manufacturing establishments are closing their doors, but the establishments still open are slowly hiring more people and the average pay per employee is increasing.

## State Highlights
### Nevada and Hawaii
#### Accommodation and Foodservice
More than other states, tourism drives employment in Nevada and Hawaii. In both states, the Accommodation and foodservice industry had the highest number of employees from 2005 through 2019. In Nevada, it accounted for the highest annual payroll, but surprisingly in Hawaii, it only accounted for the second highest annual payroll among industries in the state (highest being healthcare). 

```{r, warning = FALSE, message=FALSE}

# States that had Accomodation and foodservice as their top industry by number of employees for each year 2005 - 2019

AnnEEs<-df%>%group_by(STATE,INDUSTRY,YEAR)%>%
  summarise(IndustryEmployees=sum(EMP)) %>%
  arrange(STATE,YEAR,desc(IndustryEmployees))%>%ungroup()

AnnEEs %>% group_by(STATE,YEAR) %>%
  filter(IndustryEmployees==max(IndustryEmployees)) %>%
  filter(INDUSTRY=="Accommodation and food services") %>%
  arrange(YEAR,STATE) %>% select(YEAR,STATE) %>% group_by(YEAR) %>%
  summarise(AccomAndFoodTopEmployerStates = paste(STATE,collapse=" "))

# And Accommodation and foodservice industry for Top Annual Payroll
# Nevada 2015 - 2019 Top industry Annual Payroll

AnnPay<-df%>%group_by(STATE,INDUSTRY,YEAR)%>%
  summarise(IndustryPay=sum(PAYANN_19DOL)) %>%
  arrange(STATE,YEAR,desc(IndustryPay))%>%ungroup()

AnnPay %>% group_by(STATE,YEAR) %>%
  filter(IndustryPay==max(IndustryPay)) %>%
  filter(INDUSTRY=="Accommodation and food services") %>%
  arrange(YEAR,STATE) %>% select(YEAR,STATE) %>% group_by(YEAR) %>%
  summarise(AccomAndFoodTopPayrollStates = paste(STATE,collapse=" "))

```

#### Nevada

```{r, warning = FALSE, message=FALSE}
# Nevada
thisState ="Nevada"
thisYear = 2019

# Number of Employees: Line plot
ToPlot <- df %>% filter(STATE==thisState) %>%
  group_by(YEAR, NAIC) %>%
  summarise(TotalEmp = sum(EMP)) %>% 
  merge(industries)
cols<-ToPlot%>%group_by(NAIC,INDUSTRY)%>%summarize(pc=unique(plotColor))
ToPlot %>% 
  mutate(label = if_else(YEAR == 2019, as.character(NAIC), NA_character_)) %>%
  ggplot(aes(x=YEAR, y=TotalEmp, color=NAIC))+
  scale_colour_manual(values=cols$pc, name="Industries", labels=c(paste(cols$NAIC,cols$INDUSTRY,sep=": "))) +
  geom_line(size=1.25, alpha=.6, key_glyph="rect") +
  scale_x_continuous(n.breaks = 15, expand=c(0,0,0,2)) +
  scale_y_continuous(labels=comma) +
  geom_label_repel(aes(label = label), nudge_x=2, na.rm=TRUE, show.legend=FALSE) +
  labs(title=paste(thisState,"Total Number Employed by Industry",sep=": "), x="Year", y="Employees")


# Number of Employees: Choropleth
ToPlot <- df %>% filter(YEAR==thisYear, STATE==thisState) %>%
  group_by(FIPS_CTY, INDUSTRY) %>%
  summarise(TotalEmp = sum(EMP)) %>%
  filter(TotalEmp == max(TotalEmp)) %>% 
  merge(industries)
ToPlot<-rename(ToPlot, "fips"="FIPS_CTY")
cols<-ToPlot%>%
  group_by(INDUSTRY)%>%summarize(pc=unique(plotColor))
plot_usmap(data = ToPlot, values="INDUSTRY", include=c(thisState)) + 
  scale_fill_manual(values=cols$pc, name="Industries", labels=cols$INDUSTRY) +
  labs(title = paste(as.character(thisYear),"Top Industry by Number of Employees in", thisState,sep=" ")) + 
  theme(legend.position = "right", title=element_text(size=12))


# Annual Payroll: Line Plot
ToPlot <- df %>% filter(STATE==thisState) %>%
  group_by(YEAR, NAIC) %>%
  summarise(TotalPayAnn = sum(PAYANN_19DOL)) %>% 
  merge(industries)
cols<-ToPlot%>%group_by(NAIC,INDUSTRY)%>%summarize(pc=unique(plotColor))
ToPlot %>% 
  mutate(label = if_else(YEAR == 2019, as.character(NAIC), NA_character_)) %>%
  ggplot(aes(x=YEAR, y=TotalPayAnn, color=NAIC)) +
  scale_colour_manual(values=cols$pc, name="Industries", labels=c(paste(cols$NAIC,cols$INDUSTRY,sep=": "))) +
  geom_line(size=1.25, alpha=.6, key_glyph="rect") +
  scale_x_continuous(n.breaks = 15, expand=c(0,0,0,2)) +
  scale_y_continuous(labels=dollar) +
  geom_label_repel(aes(label = label), nudge_x=2, na.rm=TRUE, show.legend=FALSE) +
  labs(title=paste(thisState,"Total Annual Payroll by Industry (in 2019 dollars)",sep=": "), x="Year", y="Total Annual Payroll")


# Annual Payroll: Choropleth
ToPlot <- df %>% filter(YEAR==thisYear, STATE==thisState) %>%
  group_by(FIPS_CTY, INDUSTRY) %>%
  summarise(TotalPayAnn = sum(PAYANN_19DOL)) %>%
  filter(TotalPayAnn == max(TotalPayAnn)) %>% 
  merge(industries)
ToPlot<-rename(ToPlot, "fips"="FIPS_CTY")
cols<-ToPlot%>%
  group_by(INDUSTRY)%>%summarize(pc=unique(plotColor))
plot_usmap(data = ToPlot, values="INDUSTRY", include=c(thisState)) + 
  scale_fill_manual(values=cols$pc, name="Industries", labels=cols$INDUSTRY) +
  labs(title = paste(as.character(thisYear),"Top Industry by Annual Payroll in", thisState, sep=" ")) + 
  theme(legend.position = "right", title=element_text(size=12))

```

#### Hawaii

```{r, warning = FALSE, message=FALSE}
# Hawaii
thisState ="Hawaii"
thisYear = 2019

# Number of Employees: Line plot
ToPlot <- df %>% filter(STATE==thisState) %>%
  group_by(YEAR, NAIC) %>%
  summarise(TotalEmp = sum(EMP)) %>% 
  merge(industries)
cols<-ToPlot%>%group_by(NAIC,INDUSTRY)%>%summarize(pc=unique(plotColor))
ToPlot %>% 
  mutate(label = if_else(YEAR == 2019, as.character(NAIC), NA_character_)) %>%
  ggplot(aes(x=YEAR, y=TotalEmp, color=NAIC))+
  scale_colour_manual(values=cols$pc, name="Industries", labels=c(paste(cols$NAIC,cols$INDUSTRY,sep=": "))) +
  geom_line(size=1.25, alpha=.6, key_glyph="rect") +
  scale_x_continuous(n.breaks = 15, expand=c(0,0,0,2)) +
  scale_y_continuous(labels=comma) +
  geom_label_repel(aes(label = label), nudge_x=2, na.rm=TRUE, show.legend=FALSE) +
  labs(title=paste(thisState,"Total Number Employed by Industry",sep=": "), x="Year", y="Employees")


# Number of Employees: Choropleth
ToPlot <- df %>% filter(YEAR==thisYear, STATE==thisState) %>%
  group_by(FIPS_CTY, INDUSTRY) %>%
  summarise(TotalEmp = sum(EMP)) %>%
  filter(TotalEmp == max(TotalEmp)) %>% 
  merge(industries)
ToPlot<-rename(ToPlot, "fips"="FIPS_CTY")
cols<-ToPlot%>%
  group_by(INDUSTRY)%>%summarize(pc=unique(plotColor))
plot_usmap(data = ToPlot, values="INDUSTRY", include=c(thisState)) + 
  scale_fill_manual(values=cols$pc, name="Industries", labels=cols$INDUSTRY) +
  labs(title = paste(as.character(thisYear),"Top Industry by Number of Employees in", thisState,sep=" ")) + 
  theme(legend.position = "right", title=element_text(size=12))


# Annual Payroll: Line Plot
ToPlot <- df %>% filter(STATE==thisState) %>%
  group_by(YEAR, NAIC) %>%
  summarise(TotalPayAnn = sum(PAYANN_19DOL)) %>% 
  merge(industries)
cols<-ToPlot%>%group_by(NAIC,INDUSTRY)%>%summarize(pc=unique(plotColor))
ToPlot %>% 
  mutate(label = if_else(YEAR == 2019, as.character(NAIC), NA_character_)) %>%
  ggplot(aes(x=YEAR, y=TotalPayAnn, color=NAIC)) +
  scale_colour_manual(values=cols$pc, name="Industries", labels=c(paste(cols$NAIC,cols$INDUSTRY,sep=": "))) +
  geom_line(size=1.25, alpha=.6, key_glyph="rect") +
  scale_x_continuous(n.breaks = 15, expand=c(0,0,0,2)) +
  scale_y_continuous(labels=dollar) +
  geom_label_repel(aes(label = label), nudge_x=2, na.rm=TRUE, show.legend=FALSE) +
  labs(title=paste(thisState,"Total Annual Payroll by Industry (in 2019 dollars)",sep=": "), x="Year", y="Total Annual Payroll")


# Annual Payroll: Choropleth
ToPlot <- df %>% filter(YEAR==thisYear, STATE==thisState) %>%
  group_by(FIPS_CTY, INDUSTRY) %>%
  summarise(TotalPayAnn = sum(PAYANN_19DOL)) %>%
  filter(TotalPayAnn == max(TotalPayAnn)) %>% 
  merge(industries)
ToPlot<-rename(ToPlot, "fips"="FIPS_CTY")
cols<-ToPlot%>%
  group_by(INDUSTRY)%>%summarize(pc=unique(plotColor))
plot_usmap(data = ToPlot, values="INDUSTRY", include=c(thisState)) + 
  scale_fill_manual(values=cols$pc, name="Industries", labels=cols$INDUSTRY) +
  labs(title = paste(as.character(thisYear),"Top Industry by Annual Payroll in", thisState, sep=" ")) + 
  theme(legend.position = "right", title=element_text(size=12))

```



### New York, Connecticut, and Delaware
#### Finance and Insurance
From 2005 – 2009 the top industry in New York and Connecticut, by annual payroll, has been Finance and insurance. Delaware joined these leaders in finance in 2012. Not surprisingly, Finance has the highest pay rate of all industries in New York and Connecticut (second highest rate in Delaware). In Connecticut and New York, the finance industry has steadily been the fifth highest employer, but in Delaware, finance has been in the 5th and 6th positions during those 15 years.  

```{r, warning = FALSE, message=FALSE}

# States that had Finance as their top industry for Top Annual Payroll
AnnPay<-df%>%group_by(STATE,INDUSTRY,YEAR)%>%
  summarise(IndustryPay=sum(PAYANN_19DOL)) %>%
  arrange(STATE,YEAR,desc(IndustryPay))%>%ungroup()

AnnPay %>% group_by(STATE,YEAR) %>%
  filter(IndustryPay==max(IndustryPay)) %>%
  filter(INDUSTRY=="Finance and insurance") %>%
  arrange(YEAR,STATE) %>% select(YEAR,STATE) %>% group_by(YEAR) %>%
  summarise(FinanceTopPayrollStates = paste(STATE,collapse=" "))

```

#### New York

```{r, warning = FALSE, message=FALSE}
thisState ="New York"

# Annual Payroll: Line Plot
ToPlot <- df %>% filter(STATE==thisState) %>%
  group_by(YEAR, NAIC) %>%
  summarise(TotalPayAnn = sum(PAYANN_19DOL)) %>% 
  merge(industries)
cols<-ToPlot%>%group_by(NAIC,INDUSTRY)%>%summarize(pc=unique(plotColor))
ToPlot %>% 
  mutate(label = if_else(YEAR == 2019, as.character(NAIC), NA_character_)) %>%
  ggplot(aes(x=YEAR, y=TotalPayAnn, color=NAIC)) +
  scale_colour_manual(values=cols$pc, name="Industries", labels=c(paste(cols$NAIC,cols$INDUSTRY,sep=": "))) +
  geom_line(size=1.25, alpha=.6, key_glyph="rect") +
  scale_x_continuous(n.breaks = 15, expand=c(0,0,0,2)) +
  scale_y_continuous(labels=dollar) +
  geom_label_repel(aes(label = label), nudge_x=2, na.rm=TRUE, show.legend=FALSE) +
  labs(title=paste(thisState,"Total Annual Payroll by Industry (in 2019 dollars)",sep=": "), x="Year", y="Total Annual Payroll")


# Annual Payroll: Choropleth
ToPlot <- df %>% filter(YEAR==thisYear, STATE==thisState) %>%
  group_by(FIPS_CTY, INDUSTRY) %>%
  summarise(TotalPayAnn = sum(PAYANN_19DOL)) %>%
  filter(TotalPayAnn == max(TotalPayAnn)) %>% 
  merge(industries)
ToPlot<-rename(ToPlot, "fips"="FIPS_CTY")
cols<-ToPlot%>%
  group_by(INDUSTRY)%>%summarize(pc=unique(plotColor))
plot_usmap(data = ToPlot, values="INDUSTRY", include=c(thisState)) + 
  scale_fill_manual(values=cols$pc, name="Industries", labels=cols$INDUSTRY) +
  labs(title = paste(as.character(thisYear),"Top Industry by Annual Payroll in", thisState, sep=" ")) + 
  theme(legend.position = "right", title=element_text(size=12))


# Number of Employees: Line plot
ToPlot <- df %>% filter(STATE==thisState) %>%
  group_by(YEAR, NAIC) %>%
  summarise(TotalEmp = sum(EMP)) %>% 
  merge(industries)
cols<-ToPlot%>%group_by(NAIC,INDUSTRY)%>%summarize(pc=unique(plotColor))
ToPlot %>% 
  mutate(label = if_else(YEAR == 2019, as.character(NAIC), NA_character_)) %>%
  ggplot(aes(x=YEAR, y=TotalEmp, color=NAIC))+
  scale_colour_manual(values=cols$pc, name="Industries", labels=c(paste(cols$NAIC,cols$INDUSTRY,sep=": "))) +
  geom_line(size=1.25, alpha=.6, key_glyph="rect") +
  scale_x_continuous(n.breaks = 15, expand=c(0,0,0,2)) +
  scale_y_continuous(labels=comma) +
  geom_label_repel(aes(label = label), nudge_x=2, na.rm=TRUE, show.legend=FALSE) +
  labs(title=paste(thisState,"Total Number Employed by Industry",sep=": "), x="Year", y="Employees")

### Top Average Pay Rates
ToPlot <- df %>% filter(STATE==thisState) %>%
  group_by(YEAR, NAIC) %>%
  summarise(PayRate = sum(PAYANN_19DOL)/sum(EMP)) %>% 
  merge(industries)
cols<-ToPlot%>%group_by(NAIC,INDUSTRY)%>%summarize(pc=unique(plotColor))
ToPlot %>% 
  mutate(label = if_else(YEAR == 2019, as.character(NAIC), NA_character_)) %>%
  ggplot(aes(x=YEAR, y=PayRate, color=NAIC))+
  scale_colour_manual(values=cols$pc, name="Industries", labels=c(paste(cols$NAIC,cols$INDUSTRY,sep=": "))) +
  geom_line(size=1.25, alpha=.6, key_glyph="rect") +
  scale_x_continuous(n.breaks = 15, expand=c(0,0,0,2)) +
  scale_y_continuous(labels=dollar) +
  geom_label_repel(aes(label = label), nudge_x=2, na.rm=TRUE, show.legend=FALSE) +
  labs(title=paste(thisState,"Average Pay Rate by Industry (in 2019 dollars)",sep=": "), x="Year", y="Avg. Pay Rate")


```

#### Connecticut

```{r, warning = FALSE, message=FALSE}
thisState ="Connecticut"

# Annual Payroll: Line Plot
ToPlot <- df %>% filter(STATE==thisState) %>%
  group_by(YEAR, NAIC) %>%
  summarise(TotalPayAnn = sum(PAYANN_19DOL)) %>% 
  merge(industries)
cols<-ToPlot%>%group_by(NAIC,INDUSTRY)%>%summarize(pc=unique(plotColor))
ToPlot %>% 
  mutate(label = if_else(YEAR == 2019, as.character(NAIC), NA_character_)) %>%
  ggplot(aes(x=YEAR, y=TotalPayAnn, color=NAIC)) +
  scale_colour_manual(values=cols$pc, name="Industries", labels=c(paste(cols$NAIC,cols$INDUSTRY,sep=": "))) +
  geom_line(size=1.25, alpha=.6, key_glyph="rect") +
  scale_x_continuous(n.breaks = 15, expand=c(0,0,0,2)) +
  scale_y_continuous(labels=dollar) +
  geom_label_repel(aes(label = label), nudge_x=2, na.rm=TRUE, show.legend=FALSE) +
  labs(title=paste(thisState,"Total Annual Payroll by Industry (in 2019 dollars)",sep=": "), x="Year", y="Total Annual Payroll")


# Annual Payroll: Choropleth
ToPlot <- df %>% filter(YEAR==thisYear, STATE==thisState) %>%
  group_by(FIPS_CTY, INDUSTRY) %>%
  summarise(TotalPayAnn = sum(PAYANN_19DOL)) %>%
  filter(TotalPayAnn == max(TotalPayAnn)) %>% 
  merge(industries)
ToPlot<-rename(ToPlot, "fips"="FIPS_CTY")
cols<-ToPlot%>%
  group_by(INDUSTRY)%>%summarize(pc=unique(plotColor))
plot_usmap(data = ToPlot, values="INDUSTRY", include=c(thisState)) + 
  scale_fill_manual(values=cols$pc, name="Industries", labels=cols$INDUSTRY) +
  labs(title = paste(as.character(thisYear),"Top Industry by Annual Payroll in", thisState, sep=" ")) + 
  theme(legend.position = "right", title=element_text(size=12))

# Number of Employees: Line plot
ToPlot <- df %>% filter(STATE==thisState) %>%
  group_by(YEAR, NAIC) %>%
  summarise(TotalEmp = sum(EMP)) %>% 
  merge(industries)
cols<-ToPlot%>%group_by(NAIC,INDUSTRY)%>%summarize(pc=unique(plotColor))
ToPlot %>% 
  mutate(label = if_else(YEAR == 2019, as.character(NAIC), NA_character_)) %>%
  ggplot(aes(x=YEAR, y=TotalEmp, color=NAIC))+
  scale_colour_manual(values=cols$pc, name="Industries", labels=c(paste(cols$NAIC,cols$INDUSTRY,sep=": "))) +
  geom_line(size=1.25, alpha=.6, key_glyph="rect") +
  scale_x_continuous(n.breaks = 15, expand=c(0,0,0,2)) +
  scale_y_continuous(labels=comma) +
  geom_label_repel(aes(label = label), nudge_x=2, na.rm=TRUE, show.legend=FALSE) +
  labs(title=paste(thisState,"Total Number Employed by Industry",sep=": "), x="Year", y="Employees")

### Top Average Pay Rates
ToPlot <- df %>% filter(STATE==thisState) %>%
  group_by(YEAR, NAIC) %>%
  summarise(PayRate = sum(PAYANN_19DOL)/sum(EMP)) %>% 
  merge(industries)
cols<-ToPlot%>%group_by(NAIC,INDUSTRY)%>%summarize(pc=unique(plotColor))
ToPlot %>% 
  mutate(label = if_else(YEAR == 2019, as.character(NAIC), NA_character_)) %>%
  ggplot(aes(x=YEAR, y=PayRate, color=NAIC))+
  scale_colour_manual(values=cols$pc, name="Industries", labels=c(paste(cols$NAIC,cols$INDUSTRY,sep=": "))) +
  geom_line(size=1.25, alpha=.6, key_glyph="rect") +
  scale_x_continuous(n.breaks = 15, expand=c(0,0,0,2)) +
  scale_y_continuous(labels=dollar) +
  geom_label_repel(aes(label = label), nudge_x=2, na.rm=TRUE, show.legend=FALSE) +
  labs(title=paste(thisState,"Average Pay Rate by Industry (in 2019 dollars)",sep=": "), x="Year", y="Avg. Pay Rate")


```

#### Delaware

```{r, warning = FALSE, message=FALSE}
thisState ="Delaware"

# Annual Payroll: Line Plot
ToPlot <- df %>% filter(STATE==thisState) %>%
  group_by(YEAR, NAIC) %>%
  summarise(TotalPayAnn = sum(PAYANN_19DOL)) %>% 
  merge(industries)
cols<-ToPlot%>%group_by(NAIC,INDUSTRY)%>%summarize(pc=unique(plotColor))
ToPlot %>% 
  mutate(label = if_else(YEAR == 2019, as.character(NAIC), NA_character_)) %>%
  ggplot(aes(x=YEAR, y=TotalPayAnn, color=NAIC)) +
  scale_colour_manual(values=cols$pc, name="Industries", labels=c(paste(cols$NAIC,cols$INDUSTRY,sep=": "))) +
  geom_line(size=1.25, alpha=.6, key_glyph="rect") +
  scale_x_continuous(n.breaks = 15, expand=c(0,0,0,2)) +
  scale_y_continuous(labels=dollar) +
  geom_label_repel(aes(label = label), nudge_x=2, na.rm=TRUE, show.legend=FALSE) +
  labs(title=paste(thisState,"Total Annual Payroll by Industry (in 2019 dollars)",sep=": "), x="Year", y="Total Annual Payroll")


# Annual Payroll: Choropleth
ToPlot <- df %>% filter(YEAR==thisYear, STATE==thisState) %>%
  group_by(FIPS_CTY, INDUSTRY) %>%
  summarise(TotalPayAnn = sum(PAYANN_19DOL)) %>%
  filter(TotalPayAnn == max(TotalPayAnn)) %>% 
  merge(industries)
ToPlot<-rename(ToPlot, "fips"="FIPS_CTY")
cols<-ToPlot%>%
  group_by(INDUSTRY)%>%summarize(pc=unique(plotColor))
plot_usmap(data = ToPlot, values="INDUSTRY", include=c(thisState)) + 
  scale_fill_manual(values=cols$pc, name="Industries", labels=cols$INDUSTRY) +
  labs(title = paste(as.character(thisYear),"Top Industry by Annual Payroll in", thisState, sep=" ")) + 
  theme(legend.position = "right", title=element_text(size=12))


# Number of Employees: Line plot
ToPlot <- df %>% filter(STATE==thisState) %>%
  group_by(YEAR, NAIC) %>%
  summarise(TotalEmp = sum(EMP)) %>% 
  merge(industries)
cols<-ToPlot%>%group_by(NAIC,INDUSTRY)%>%summarize(pc=unique(plotColor))
ToPlot %>% 
  mutate(label = if_else(YEAR == 2019, as.character(NAIC), NA_character_)) %>%
  ggplot(aes(x=YEAR, y=TotalEmp, color=NAIC))+
  scale_colour_manual(values=cols$pc, name="Industries", labels=c(paste(cols$NAIC,cols$INDUSTRY,sep=": "))) +
  geom_line(size=1.25, alpha=.6, key_glyph="rect") +
  scale_x_continuous(n.breaks = 15, expand=c(0,0,0,2)) +
  scale_y_continuous(labels=comma) +
  geom_label_repel(aes(label = label), nudge_x=2, na.rm=TRUE, show.legend=FALSE) +
  labs(title=paste(thisState,"Total Number Employed by Industry",sep=": "), x="Year", y="Employees")

### Top Average Pay Rates
ToPlot <- df %>% filter(STATE==thisState) %>%
  group_by(YEAR, NAIC) %>%
  summarise(PayRate = sum(PAYANN_19DOL)/sum(EMP)) %>% 
  merge(industries)
cols<-ToPlot%>%group_by(NAIC,INDUSTRY)%>%summarize(pc=unique(plotColor))
ToPlot %>% 
  mutate(label = if_else(YEAR == 2019, as.character(NAIC), NA_character_)) %>%
  ggplot(aes(x=YEAR, y=PayRate, color=NAIC))+
  scale_colour_manual(values=cols$pc, name="Industries", labels=c(paste(cols$NAIC,cols$INDUSTRY,sep=": "))) +
  geom_line(size=1.25, alpha=.6, key_glyph="rect") +
  scale_x_continuous(n.breaks = 15, expand=c(0,0,0,2)) +
  scale_y_continuous(labels=dollar) +
  geom_label_repel(aes(label = label), nudge_x=2, na.rm=TRUE, show.legend=FALSE) +
  labs(title=paste(thisState,"Average Pay Rate by Industry (in 2019 dollars)",sep=": "), x="Year", y="Avg. Pay Rate")

```


### Wisconsin and Indiana
#### Manufacturing
While in the past more states saw manufacturing providing the most jobs for its people, since 2009 that has only consistently been true for Wisconsin and Indiana. While the average pay for manufacturing workers has been climbing, it falls squarely in the middle of the pack in relation to the average pay in other industries.

```{r, warning = FALSE, message=FALSE,fig.width = 16}

# States that had Manufacturing as their top industry by number of employees for each year 2005 - 2019

AnnEEs<-df%>%group_by(STATE,INDUSTRY,YEAR)%>%
  summarise(IndustryEmployees=sum(EMP)) %>%
  arrange(STATE,YEAR,desc(IndustryEmployees))%>%ungroup()

Man<-AnnEEs %>% group_by(STATE,YEAR) %>%
  filter(IndustryEmployees==max(IndustryEmployees)) %>%
  filter(INDUSTRY=="Manufacturing") %>%
  arrange(YEAR,STATE) %>% select(YEAR,STATE) %>% group_by(YEAR) %>%
  summarise(ManufacturingTopEmployerStates = paste(STATE,collapse=" "))

print(Man)

```

#### Wisconsin
```{r, warning = FALSE, message=FALSE}
thisState ="Wisconsin"

# Number of Employees: Line plot
ToPlot <- df %>% filter(STATE==thisState) %>%
  group_by(YEAR, NAIC) %>%
  summarise(TotalEmp = sum(EMP)) %>% 
  merge(industries)
cols<-ToPlot%>%group_by(NAIC,INDUSTRY)%>%summarize(pc=unique(plotColor))
ToPlot %>% 
  mutate(label = if_else(YEAR == 2019, as.character(NAIC), NA_character_)) %>%
  ggplot(aes(x=YEAR, y=TotalEmp, color=NAIC))+
  scale_colour_manual(values=cols$pc, name="Industries", labels=c(paste(cols$NAIC,cols$INDUSTRY,sep=": "))) +
  geom_line(size=1.25, alpha=.6, key_glyph="rect") +
  scale_x_continuous(n.breaks = 15, expand=c(0,0,0,2)) +
  scale_y_continuous(labels=comma) +
  geom_label_repel(aes(label = label), nudge_x=2, na.rm=TRUE, show.legend=FALSE) +
  labs(title=paste(thisState,"Total Number Employed by Industry",sep=": "), x="Year", y="Employees")


# Annual Payroll: Line Plot
ToPlot <- df %>% filter(STATE==thisState) %>%
  group_by(YEAR, NAIC) %>%
  summarise(TotalPayAnn = sum(PAYANN_19DOL)) %>% 
  merge(industries)
cols<-ToPlot%>%group_by(NAIC,INDUSTRY)%>%summarize(pc=unique(plotColor))
ToPlot %>% 
  mutate(label = if_else(YEAR == 2019, as.character(NAIC), NA_character_)) %>%
  ggplot(aes(x=YEAR, y=TotalPayAnn, color=NAIC)) +
  scale_colour_manual(values=cols$pc, name="Industries", labels=c(paste(cols$NAIC,cols$INDUSTRY,sep=": "))) +
  geom_line(size=1.25, alpha=.6, key_glyph="rect") +
  scale_x_continuous(n.breaks = 15, expand=c(0,0,0,2)) +
  scale_y_continuous(labels=dollar) +
  geom_label_repel(aes(label = label), nudge_x=2, na.rm=TRUE, show.legend=FALSE) +
  labs(title=paste(thisState,"Total Annual Payroll by Industry (in 2019 dollars)",sep=": "), x="Year", y="Total Annual Payroll")

# Annual Payroll: Choropleth
ToPlot <- df %>% filter(YEAR==thisYear, STATE==thisState) %>%
  group_by(FIPS_CTY, INDUSTRY) %>%
  summarise(TotalPayAnn = sum(PAYANN_19DOL)) %>%
  filter(TotalPayAnn == max(TotalPayAnn)) %>% 
  merge(industries)
ToPlot<-rename(ToPlot, "fips"="FIPS_CTY")
cols<-ToPlot%>%
  group_by(INDUSTRY)%>%summarize(pc=unique(plotColor))
plot_usmap(data = ToPlot, values="INDUSTRY", include=c(thisState)) + 
  scale_fill_manual(values=cols$pc, name="Industries", labels=cols$INDUSTRY) +
  labs(title = paste(as.character(thisYear),"Top Industry by Annual Payroll in", thisState, sep=" ")) + 
  theme(legend.position = "right", title=element_text(size=12))

# Average Payrate: Line Plot
ToPlot <- df %>% filter(STATE==thisState) %>%
  group_by(YEAR, NAIC) %>%
  summarise(PayRate = sum(PAYANN_19DOL)/sum(EMP)) %>% 
  merge(industries)
cols<-ToPlot%>%group_by(NAIC,INDUSTRY)%>%summarize(pc=unique(plotColor))
ToPlot %>% 
  mutate(label = if_else(YEAR == 2019, as.character(NAIC), NA_character_)) %>%
  ggplot(aes(x=YEAR, y=PayRate, color=NAIC))+
  scale_colour_manual(values=cols$pc, name="Industries", labels=c(paste(cols$NAIC,cols$INDUSTRY,sep=": "))) +
  geom_line(size=1.25, alpha=.6, key_glyph="rect") +
  scale_x_continuous(n.breaks = 15, expand=c(0,0,0,2)) +
  scale_y_continuous(labels=dollar) +
  geom_label_repel(aes(label = label), nudge_x=2, na.rm=TRUE, show.legend=FALSE) +
  labs(title=paste(thisState,"Average Pay Rate by Industry (in 2019 dollars)",sep=": "), x="Year", y="Avg. Pay Rate")

```

#### Indiana
```{r, warning = FALSE, message=FALSE}
thisState ="Indiana"

# Number of Employees: Line plot
ToPlot <- df %>% filter(STATE==thisState) %>%
  group_by(YEAR, NAIC) %>%
  summarise(TotalEmp = sum(EMP)) %>% 
  merge(industries)
cols<-ToPlot%>%group_by(NAIC,INDUSTRY)%>%summarize(pc=unique(plotColor))
ToPlot %>% 
  mutate(label = if_else(YEAR == 2019, as.character(NAIC), NA_character_)) %>%
  ggplot(aes(x=YEAR, y=TotalEmp, color=NAIC))+
  scale_colour_manual(values=cols$pc, name="Industries", labels=c(paste(cols$NAIC,cols$INDUSTRY,sep=": "))) +
  geom_line(size=1.25, alpha=.6, key_glyph="rect") +
  scale_x_continuous(n.breaks = 15, expand=c(0,0,0,2)) +
  scale_y_continuous(labels=comma) +
  geom_label_repel(aes(label = label), nudge_x=2, na.rm=TRUE, show.legend=FALSE) +
  labs(title=paste(thisState,"Total Number Employed by Industry",sep=": "), x="Year", y="Employees")


# Annual Payroll: Line Plot
ToPlot <- df %>% filter(STATE==thisState) %>%
  group_by(YEAR, NAIC) %>%
  summarise(TotalPayAnn = sum(PAYANN_19DOL)) %>% 
  merge(industries)
cols<-ToPlot%>%group_by(NAIC,INDUSTRY)%>%summarize(pc=unique(plotColor))
ToPlot %>% 
  mutate(label = if_else(YEAR == 2019, as.character(NAIC), NA_character_)) %>%
  ggplot(aes(x=YEAR, y=TotalPayAnn, color=NAIC)) +
  scale_colour_manual(values=cols$pc, name="Industries", labels=c(paste(cols$NAIC,cols$INDUSTRY,sep=": "))) +
  geom_line(size=1.25, alpha=.6, key_glyph="rect") +
  scale_x_continuous(n.breaks = 15, expand=c(0,0,0,2)) +
  scale_y_continuous(labels=dollar) +
  geom_label_repel(aes(label = label), nudge_x=2, na.rm=TRUE, show.legend=FALSE) +
  labs(title=paste(thisState,"Total Annual Payroll by Industry (in 2019 dollars)",sep=": "), x="Year", y="Total Annual Payroll")

# Annual Payroll: Choropleth
ToPlot <- df %>% filter(YEAR==thisYear, STATE==thisState) %>%
  group_by(FIPS_CTY, INDUSTRY) %>%
  summarise(TotalPayAnn = sum(PAYANN_19DOL)) %>%
  filter(TotalPayAnn == max(TotalPayAnn)) %>% 
  merge(industries)
ToPlot<-rename(ToPlot, "fips"="FIPS_CTY")
cols<-ToPlot%>%
  group_by(INDUSTRY)%>%summarize(pc=unique(plotColor))
plot_usmap(data = ToPlot, values="INDUSTRY", include=c(thisState)) + 
  scale_fill_manual(values=cols$pc, name="Industries", labels=cols$INDUSTRY) +
  labs(title = paste(as.character(thisYear),"Top Industry by Annual Payroll in", thisState, sep=" ")) + 
  theme(legend.position = "right", title=element_text(size=12))

# Average Payrate: Line Plot
ToPlot <- df %>% filter(STATE==thisState) %>%
  group_by(YEAR, NAIC) %>%
  summarise(PayRate = sum(PAYANN_19DOL)/sum(EMP)) %>% 
  merge(industries)
cols<-ToPlot%>%group_by(NAIC,INDUSTRY)%>%summarize(pc=unique(plotColor))
ToPlot %>% 
  mutate(label = if_else(YEAR == 2019, as.character(NAIC), NA_character_)) %>%
  ggplot(aes(x=YEAR, y=PayRate, color=NAIC))+
  scale_colour_manual(values=cols$pc, name="Industries", labels=c(paste(cols$NAIC,cols$INDUSTRY,sep=": "))) +
  geom_line(size=1.25, alpha=.6, key_glyph="rect") +
  scale_x_continuous(n.breaks = 15, expand=c(0,0,0,2)) +
  scale_y_continuous(labels=dollar) +
  geom_label_repel(aes(label = label), nudge_x=2, na.rm=TRUE, show.legend=FALSE) +
  labs(title=paste(thisState,"Average Pay Rate by Industry (in 2019 dollars)",sep=": "), x="Year", y="Avg. Pay Rate")

```

# Conclusion
Throughout the analysis, we discovered a lot about how industries affect the United States. Some findings did not surprise us as much as others did, such as the decreases seen in manufacturing over the years and the number of retail establishments across the United States. We hear about these things on the news and are all too familiar with ordering products that are imported into the United States. When we started the project, we expected to find these trends in the data. However, we were shocked and surprised by other findings that caused us to dig into how economic changes, advances in technology, and changes in politics such as funding for specific industries or tariffs may have played a role in the growth or decline of a specific industry during a specific period. A fitting example of this was the growth in utilities. We initially saw a spike in the data and after some additional research, we were able to pinpoint legislation that occurred during the same period as the abnormal growth in that industry. Visualizations, if done correctly, are supposed to make these types of “ah-ha” moments easier and provide the reader points of interest to dig into or an understanding of what is going on to draw appropriate conclusions. Throughout this analysis, our choropleth maps and other visualizations helped us identify interesting findings in the data and draw conclusions.  

### Future Exploration 
If we were to continue exploring this data, we would still have much to uncover and understand. We would like to focus more on the social impacts of industry changes. For instance, at the micro level, how is a community or metropolitan area impacted when a company or industry relocates into or out of the area? How does that impact the community in subsequent years? We are interested in what industry adjustments happened in the years before and after the decline of Detroit’s automotive manufacturing and the city of Detroit filing for bankruptcy in 2013. We are also interested in how population density can change industry dominance within a state. As an example, in New York state, the top industry is Finance & Insurance, but how much of that is that because of the New York City metro area dominating the state employment totals? Future explorations focused on population, population density, and “urban versus rural” trends could address these outstanding questions. 


# Plots used in exploration

```{r}

# Faceted line charts (employees, establishments, payroll)
ToPlot <- df %>%
  group_by(YEAR, NAIC) %>%
  summarise(TotalEstab = sum(ESTAB),
            TotalEmp = sum(EMP),
            TotalPay = sum(PAYANN_19DOL)) %>%
  merge(industries)

ggplot(ToPlot) +
  geom_line(aes(x=YEAR,y=TotalEstab)) +
  facet_wrap(~NAIC)+
  theme(axis.text.x = element_text(angle = 90),axis.title.x = element_blank(),axis.title.y = element_blank()) +
  scale_y_continuous(labels = comma) +
  labs(title="Number of Establishments Per Industry by Year")

ggplot(ToPlot) +
  geom_line(aes(x=YEAR,y=TotalEmp)) +
  facet_wrap(~NAIC)+
  theme(axis.text.x = element_text(angle = 90),axis.title.x = element_blank(),axis.title.y = element_blank()) +
  scale_y_continuous(labels = comma) +
  labs(title="Number of Total Employees Per Industry by Year")

ggplot(ToPlot) +
  geom_line(aes(x=YEAR,y=TotalPay)) +
  facet_wrap(~NAIC)+
  theme(axis.text.x = element_text(angle = 90),axis.title.x = element_blank(),axis.title.y = element_blank()) +
  scale_y_continuous(labels = comma) +
  labs(title="Amount of Total Pay Per Industry by Year")
```


## US CHOROPLETHS

### Top Annual Payroll by Industry by state by year

```{r}

# Top Annual Payroll by Industry by state by year
#Inflation Adj

thisYear = 2019 # Just change this line to customize for year

ToPlot <- df %>% filter(YEAR==thisYear) %>%
  group_by(FIPS_ST, INDUSTRY) %>%
  summarise(TotalPayAnn = sum(PAYANN_19DOL)) %>%
  filter(TotalPayAnn == max(TotalPayAnn)) %>% 
  merge(industries)
ToPlot<-rename(ToPlot, "fips"="FIPS_ST")

cols<-ToPlot%>%
  group_by(INDUSTRY)%>%summarize(pc=unique(plotColor))

plot_usmap(data = ToPlot, values="INDUSTRY") + 
  scale_fill_manual(values=cols$pc, name="Industries", labels=cols$INDUSTRY) +
  labs(title = paste(as.character(thisYear),"Top Industry by Annual Payroll in Each State",sep=" ")) + 
  theme(legend.position = "right", title=element_text(size=12))

```

### Top Number of Employees by Industry by state by year

```{r}

thisYear = 2019 # Just change this line to customize for year

ToPlot <- df %>% filter(YEAR==thisYear) %>%
  group_by(FIPS_ST, INDUSTRY) %>%
  summarise(TotalEmp = sum(EMP)) %>%
  filter(TotalEmp == max(TotalEmp)) %>% 
  merge(industries)
ToPlot<-rename(ToPlot, "fips"="FIPS_ST")

cols<-ToPlot%>%
  group_by(INDUSTRY)%>%summarize(pc=unique(plotColor))

plot_usmap(data = ToPlot, values="INDUSTRY") + 
  scale_fill_manual(values=cols$pc, name="Industries", labels=cols$INDUSTRY) +
  labs(title = paste(as.character(thisYear),"Top Industry by Number of Employees in Each State",sep=" ")) + 
  theme(legend.position = "right", title=element_text(size=12))

```

### Top Number of Establishments by Industry by state by year

```{r}

thisYear = 2019 # Just change this line to customize for year

ToPlot <- df %>% filter(YEAR==thisYear) %>%
  group_by(FIPS_ST, INDUSTRY) %>%
  summarise(TotalEstab = sum(ESTAB)) %>%
  filter(TotalEstab == max(TotalEstab)) %>% 
  merge(industries)
ToPlot<-rename(ToPlot, "fips"="FIPS_ST")

cols<-ToPlot%>%
  group_by(INDUSTRY)%>%summarize(pc=unique(plotColor))

plot_usmap(data = ToPlot, values="INDUSTRY") + 
  scale_fill_manual(values=cols$pc, name="Industries", labels=cols$INDUSTRY) +
  labs(title = paste(as.character(thisYear),"Top Industry by Number of Establishments in Each State",sep=" ")) + 
  theme(legend.position = "right", title=element_text(size=12))

```

### Highest Pay rate by Industry by state by year

```{r}

thisYear = 2019 # Just change this line to customize for year

ToPlot <- df %>% filter(YEAR==thisYear) %>%
  group_by(FIPS_ST, INDUSTRY) %>%
  summarise(PayRate = sum(PAYANN_19DOL)/sum(EMP)) %>%
  filter(PayRate == max(PayRate)) %>% 
  merge(industries)
ToPlot<-rename(ToPlot, "fips"="FIPS_ST")

cols<-ToPlot%>%
  group_by(INDUSTRY)%>%summarize(pc=unique(plotColor))

plot_usmap(data = ToPlot, values="INDUSTRY") + 
  scale_fill_manual(values=cols$pc, name="Industries", labels=cols$INDUSTRY) +
  labs(title = paste(as.character(thisYear),"Highest Pay rate by Industry in Each State",sep=" ")) + 
  theme(legend.position = "right", title=element_text(size=12))

```

## STATE CHOROPLETHS

### Top Annual Payroll by Industry in State by year

```{r}
thisState = "Iowa" # Just change this line to customize for state
thisYear = 2019 # Just change this line to customize for year

ToPlot <- df %>% filter(YEAR==thisYear, STATE==thisState) %>%
  group_by(FIPS_CTY, INDUSTRY) %>%
  summarise(TotalPayAnn = sum(PAYANN_19DOL)) %>%
  filter(TotalPayAnn == max(TotalPayAnn)) %>% 
  merge(industries)
ToPlot<-rename(ToPlot, "fips"="FIPS_CTY")

cols<-ToPlot%>%
  group_by(INDUSTRY)%>%summarize(pc=unique(plotColor))

plot_usmap(data = ToPlot, values="INDUSTRY", include=c(thisState)) + 
  scale_fill_manual(values=cols$pc, name="Industries", labels=cols$INDUSTRY) +
  labs(title = paste(as.character(thisYear),"Top Industry by Annual Payroll in", thisState,sep=" ")) + 
  theme(legend.position = "right", title=element_text(size=12))

```

### Top Number of Employees by Industry in a State by year

```{r}
thisState = "Iowa" # Just change this line to customize for state
thisYear = 2019 # Just change this line to customize for year

ToPlot <- df %>% filter(YEAR==thisYear, STATE==thisState) %>%
  group_by(FIPS_CTY, INDUSTRY) %>%
  summarise(TotalEmp = sum(EMP)) %>%
  filter(TotalEmp == max(TotalEmp)) %>% 
  merge(industries)
ToPlot<-rename(ToPlot, "fips"="FIPS_CTY")

cols<-ToPlot%>%
  group_by(INDUSTRY)%>%summarize(pc=unique(plotColor))

plot_usmap(data = ToPlot, values="INDUSTRY", include=c(thisState)) + 
  scale_fill_manual(values=cols$pc, name="Industries", labels=cols$INDUSTRY) +
  labs(title = paste(as.character(thisYear),"Top Industry by Number of Employees in", thisState,sep=" ")) + 
  theme(legend.position = "right", title=element_text(size=12))

```

### Top Number of Establishments by Industry in a State by year

```{r}
thisState = "Iowa" # Just change this line to customize for state
thisYear = 2019 # Just change this line to customize for year

ToPlot <- df %>% filter(YEAR==thisYear, STATE==thisState) %>%
  group_by(FIPS_CTY, INDUSTRY) %>%
  summarise(TotalEstab = sum(ESTAB)) %>%
  filter(TotalEstab == max(TotalEstab)) %>% 
  merge(industries)
ToPlot<-rename(ToPlot, "fips"="FIPS_CTY")

cols<-ToPlot%>%
  group_by(INDUSTRY)%>%summarize(pc=unique(plotColor))

plot_usmap(data = ToPlot, values="INDUSTRY", include=c(thisState)) + 
  scale_fill_manual(values=cols$pc, name="Industries", labels=cols$INDUSTRY) +
  labs(title = paste(as.character(thisYear),"Top Industry by Number of Establishments in", thisState,sep=" ")) + 
  theme(legend.position = "right", title=element_text(size=12))

```


### Highest Pay rate by Industry in Each County by year

```{r}
thisState = "Iowa" # Just change this line to customize for state
thisYear = 2019 # Just change this line to customize for year

ToPlot <- df %>% filter(YEAR==thisYear, STATE==thisState) %>%
  group_by(FIPS_CTY, INDUSTRY) %>%
  summarise(PayRate = sum(PAYANN_19DOL)/sum(EMP)) %>%
  filter(PayRate == max(PayRate)) %>% 
  merge(industries)
ToPlot<-rename(ToPlot, "fips"="FIPS_CTY")

cols<-ToPlot%>%
  group_by(INDUSTRY)%>%summarize(pc=unique(plotColor))

plot_usmap(data = ToPlot, values="INDUSTRY", include=c(thisState)) + 
  scale_fill_manual(values=cols$pc, name="Industries", labels=cols$INDUSTRY) +
  labs(title = paste(as.character(thisYear),"Highest Pay rate by Industry in", thisState,sep=" ")) + 
  theme(legend.position = "right", title=element_text(size=12))

```

# LINE GRAPHS
## US Line graphs
For best results run the plot in the console window or an r script to be able to export or zoom into the plot. Export at 1200 x 800 to fit 2 plots per page.

### Entire US - Annual Payroll by Industry

```{r}

# All States
# For best results run the plot in the console window or an r script to be able to export or zoom into the plot
ToPlot <- df %>%
  group_by(YEAR, NAIC) %>%
  summarise(TotalPayAnn = sum(PAYANN_19DOL)) %>% 
  merge(industries)

cols<-ToPlot%>%group_by(NAIC,INDUSTRY)%>%summarize(pc=unique(plotColor))

ToPlot %>% 
  mutate(label = if_else(YEAR == 2019, as.character(NAIC), NA_character_)) %>%
  ggplot(aes(x=YEAR, y=TotalPayAnn, color=NAIC)) +
  scale_colour_manual(values=cols$pc, name="Industries", labels=c(paste(cols$NAIC,cols$INDUSTRY,sep=": "))) +
  geom_line(size=1.25, alpha=.6, key_glyph="rect") +
  scale_x_continuous(n.breaks = 15, expand=c(0,0,0,2)) +
  scale_y_continuous(labels=dollar) +
  geom_label_repel(aes(label = label), nudge_x=2, na.rm=TRUE, show.legend=FALSE) +
  labs(title="United States: Total Annual Payroll by Industry (in 2019 dollars)", x="Year", y="Total Annual Payroll")

```

### Entire US - Number Employed by Industry

```{r}

# All States
# For best results run the plot in the console window or an r script to be able to export or zoom into the plot
ToPlot <- df %>%
  group_by(YEAR, NAIC) %>%
  summarise(TotalEmp = sum(EMP)) %>% 
  merge(industries)

cols<-ToPlot%>%group_by(NAIC,INDUSTRY)%>%summarize(pc=unique(plotColor))

ToPlot %>% 
  mutate(label = if_else(YEAR == 2019, as.character(NAIC), NA_character_)) %>%
  ggplot(aes(x=YEAR, y=TotalEmp, color=NAIC))+
  scale_colour_manual(values=cols$pc, name="Industries", labels=c(paste(cols$NAIC,cols$INDUSTRY,sep=": "))) +
  geom_line(size=1.25, alpha=.6, key_glyph="rect") +
  scale_x_continuous(n.breaks = 15, expand=c(0,0,0,2)) +
  scale_y_continuous(labels=comma) +
  geom_label_repel(aes(label = label), nudge_x=2, na.rm=TRUE, show.legend=FALSE) +
  labs(title="United States: Total Number Employed by Industry", x="Year", y="Employees")

```

### Entire US - Number of Establishments by Industry

```{r}

# All States
# For best results run the plot in the console window or an r script to be able to export or zoom into the plot
ToPlot <- df %>%
  group_by(YEAR, NAIC) %>%
  summarise(TotalEstab = sum(ESTAB)) %>% 
  merge(industries)

cols<-ToPlot%>%group_by(NAIC,INDUSTRY)%>%summarize(pc=unique(plotColor))

ToPlot %>% 
  mutate(label = if_else(YEAR == 2019, as.character(NAIC), NA_character_)) %>%
  ggplot(aes(x=YEAR, y=TotalEstab, color=NAIC))+
  scale_colour_manual(values=cols$pc, name="Industries", labels=c(paste(cols$NAIC,cols$INDUSTRY,sep=": "))) +
  geom_line(size=1.25, alpha=.6, key_glyph="rect") +
  scale_x_continuous(n.breaks = 15, expand=c(0,0,0,2)) +
  scale_y_continuous(labels=comma) +
  geom_label_repel(aes(label = label), nudge_x=2, na.rm=TRUE, show.legend=FALSE) +
  labs(title="United States: Total Number Establishments by Industry", x="Year", y="Establishments")

```

### Entire US: Average Pay Rates

```{r}

# All States
ToPlot <- df %>%
  group_by(YEAR, NAIC) %>%
  summarise(PayRate = sum(PAYANN_19DOL)/sum(EMP)) %>% 
  merge(industries)

cols<-ToPlot%>%group_by(NAIC,INDUSTRY)%>%summarize(pc=unique(plotColor))

ToPlot %>% 
  mutate(label = if_else(YEAR == 2019, as.character(NAIC), NA_character_)) %>%
  ggplot(aes(x=YEAR, y=PayRate, color=NAIC))+
  scale_colour_manual(values=cols$pc, name="Industries", labels=c(paste(cols$NAIC,cols$INDUSTRY,sep=": "))) +
  geom_line(size=1.25, alpha=.6, key_glyph="rect") +
  scale_x_continuous(n.breaks = 15, expand=c(0,0,0,2)) +
  scale_y_continuous(labels=dollar) +
  geom_label_repel(aes(label = label), nudge_x=2, na.rm=TRUE, show.legend=FALSE) +
  labs(title="United States: Average Pay Rate by Industry (in 2019 dollars)", x="Year", y="Avg. Pay Rate")

```

### Entire US: Average Employees per Establishment

```{r}

# All States
ToPlot <- df %>%
  group_by(YEAR, NAIC) %>%
  summarise(EERate = sum(EMP)/sum(ESTAB)) %>% 
  merge(industries)

cols<-ToPlot%>%group_by(NAIC,INDUSTRY)%>%summarize(pc=unique(plotColor))

ToPlot %>% 
  mutate(label = if_else(YEAR == 2019, as.character(NAIC), NA_character_)) %>%
  ggplot(aes(x=YEAR, y=EERate, color=NAIC))+
  scale_colour_manual(values=cols$pc, name="Industries", labels=c(paste(cols$NAIC,cols$INDUSTRY,sep=": "))) +
  geom_line(size=1.25, alpha=.6, key_glyph="rect") +
  scale_x_continuous(n.breaks = 15, expand=c(0,0,0,2)) +
  scale_y_continuous(labels=comma) +
  geom_label_repel(aes(label = label), nudge_x=2, na.rm=TRUE, show.legend=FALSE) +
  labs(title="United States: Average Employees per Establishment by Industry", x="Year", y="Employees per Establishment")

```

## State Line graphs

### One state - Annual Payroll by Industry (in 2019 dollars)

```{r}

thisState ="Iowa"  #Only need to change this line to customize to a state

ToPlot <- df %>% filter(STATE==thisState) %>%
  group_by(YEAR, NAIC) %>%
  summarise(TotalPayAnn = sum(PAYANN_19DOL)) %>% 
  merge(industries)

cols<-ToPlot%>%group_by(NAIC,INDUSTRY)%>%summarize(pc=unique(plotColor))

ToPlot %>% 
  mutate(label = if_else(YEAR == 2019, as.character(NAIC), NA_character_)) %>%
  ggplot(aes(x=YEAR, y=TotalPayAnn, color=NAIC)) +
  scale_colour_manual(values=cols$pc, name="Industries", labels=c(paste(cols$NAIC,cols$INDUSTRY,sep=": "))) +
  geom_line(size=1.25, alpha=.6, key_glyph="rect") +
  scale_x_continuous(n.breaks = 15, expand=c(0,0,0,2)) +
  scale_y_continuous(labels=dollar) +
  geom_label_repel(aes(label = label), nudge_x=2, na.rm=TRUE, show.legend=FALSE) +
  labs(title=paste(thisState,"Total Annual Payroll by Industry (in 2019 dollars)",sep=": "), x="Year", y="Total Annual Payroll")

```

### One State - Number Employed by Industry

```{r}

thisState ="Iowa"  #Only need to change this line to customize to a state

ToPlot <- df %>% filter(STATE==thisState) %>%
  group_by(YEAR, NAIC) %>%
  summarise(TotalEmp = sum(EMP)) %>% 
  merge(industries)

cols<-ToPlot%>%group_by(NAIC,INDUSTRY)%>%summarize(pc=unique(plotColor))

ToPlot %>% 
  mutate(label = if_else(YEAR == 2019, as.character(NAIC), NA_character_)) %>%
  ggplot(aes(x=YEAR, y=TotalEmp, color=NAIC))+
  scale_colour_manual(values=cols$pc, name="Industries", labels=c(paste(cols$NAIC,cols$INDUSTRY,sep=": "))) +
  geom_line(size=1.25, alpha=.6, key_glyph="rect") +
  scale_x_continuous(n.breaks = 15, expand=c(0,0,0,2)) +
  scale_y_continuous(labels=comma) +
  geom_label_repel(aes(label = label), nudge_x=2, na.rm=TRUE, show.legend=FALSE) +
  labs(title=paste(thisState,"Total Number Employed by Industry",sep=": "), x="Year", y="Employees")

```

### One State - Number of Establishments by Industry

```{r}

thisState ="Iowa"  #Only need to change this line to customize to a state

ToPlot <- df %>% filter(STATE==thisState) %>%
  group_by(YEAR, NAIC) %>%
  summarise(TotalEstab = sum(ESTAB)) %>% 
  merge(industries)

cols<-ToPlot%>%group_by(NAIC,INDUSTRY)%>%summarize(pc=unique(plotColor))

ToPlot %>% 
  mutate(label = if_else(YEAR == 2019, as.character(NAIC), NA_character_)) %>%
  ggplot(aes(x=YEAR, y=TotalEstab, color=NAIC))+
  scale_colour_manual(values=cols$pc, name="Industries", labels=c(paste(cols$NAIC,cols$INDUSTRY,sep=": "))) +
  geom_line(size=1.25, alpha=.6, key_glyph="rect") +
  scale_x_continuous(n.breaks = 15, expand=c(0,0,0,2)) +
  scale_y_continuous(labels=comma) +
  geom_label_repel(aes(label = label), nudge_x=2, na.rm=TRUE, show.legend=FALSE) +
  labs(title=paste(thisState,"Total Number Establishments by Industry",sep=": "), x="Year", y="Establishments")

```

### One State: Average Pay Rates

```{r}

thisState ="Iowa"  #Only need to change this line to customize to a state

ToPlot <- df %>% filter(STATE==thisState) %>%
  group_by(YEAR, NAIC) %>%
  summarise(PayRate = sum(PAYANN_19DOL)/sum(EMP)) %>% 
  merge(industries)

cols<-ToPlot%>%group_by(NAIC,INDUSTRY)%>%summarize(pc=unique(plotColor))

ToPlot %>% 
  mutate(label = if_else(YEAR == 2019, as.character(NAIC), NA_character_)) %>%
  ggplot(aes(x=YEAR, y=PayRate, color=NAIC))+
  scale_colour_manual(values=cols$pc, name="Industries", labels=c(paste(cols$NAIC,cols$INDUSTRY,sep=": "))) +
  geom_line(size=1.25, alpha=.6, key_glyph="rect") +
  scale_x_continuous(n.breaks = 15, expand=c(0,0,0,2)) +
  scale_y_continuous(labels=dollar) +
  geom_label_repel(aes(label = label), nudge_x=2, na.rm=TRUE, show.legend=FALSE) +
  labs(title=paste(thisState,"Average Pay Rate by Industry (in 2019 dollars)",sep=": "), x="Year", y="Avg. Pay Rate")

```

